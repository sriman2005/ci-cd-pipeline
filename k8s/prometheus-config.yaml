# Prometheus ServiceMonitor for auto-discovery of ci-cd-app pods
# 
# Prerequisites:
# 1. Prometheus Operator installed in cluster
# 2. Or use the scrape config section for standalone Prometheus
#
# For Docker Desktop Kubernetes, use the standalone scrape config below

---
# Option 1: ServiceMonitor (if using Prometheus Operator)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: ci-cd-app-monitor
  namespace: ci-cd-app
  labels:
    app: ci-cd-app
    release: prometheus
spec:
  selector:
    matchLabels:
      app: ci-cd-app
  namespaceSelector:
    matchNames:
      - ci-cd-app
  endpoints:
    - port: http
      path: /metrics
      interval: 15s
      scrapeTimeout: 10s

---
# Option 2: Prometheus ConfigMap (for standalone Prometheus)
# Add this to your prometheus.yml scrape_configs section
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-scrape-config
  namespace: monitoring
data:
  prometheus-additional.yaml: |
    - job_name: 'ci-cd-app'
      kubernetes_sd_configs:
        - role: pod
          namespaces:
            names:
              - ci-cd-app
      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: true
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
          action: replace
          target_label: __metrics_path__
          regex: (.+)
        - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          target_label: __address__
        - source_labels: [__meta_kubernetes_namespace]
          action: replace
          target_label: kubernetes_namespace
        - source_labels: [__meta_kubernetes_pod_name]
          action: replace
          target_label: kubernetes_pod_name
